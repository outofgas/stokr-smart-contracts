# Makefile for processing Dia documents
# G. Baecker, Tecneos UG, 2018

# Should run on FreeBSD and Linux
.POSIX:

ALL_DIAGRAMS = contracts.dia
CONTRACTS_DIAGRAM = contracts.dia
CONTRACTS_SOL_DIR = autogenerated

ALL_EPSS = $(ALL_DIAGRAMS:.dia=.eps)
ALL_PDFS = $(ALL_DIAGRAMS:.dia=.pdf)
ALL_SVGS = $(ALL_DIAGRAMS:.dia=.svg)

DIA = dia
DIA2SOL = tools/dia2sol.sh

.PHONY: help all eps pdf svg code clean
.SILENT:
.SUFFIXES: .dia .eps .pdf .svg

help:
	echo "USAGE:"
	echo "    make help        # show this help"
	echo "    make all         # create all of the following"
	echo "    make <name>.eps  # create EPS file from <name>.dia"
	echo "    make <name>.pdf  # create PDF file from <name>.dia"
	echo "    make <name>.svg  # create SVG file from <name>.dia"
	echo "    make eps         # create EPS files from all diagrams"
	echo "    make pdf         # create PDF files from all diagrams"
	echo "    make svg         # create SVG files from all diagrams"
	echo "    make code        # create Solidity contract code stubs"
	echo "                       from the contracts diagram"
	echo "    make clean       # remove all created files"

all: eps pdf svg code

eps: $(ALL_EPSS)
pdf: $(ALL_PDFS)
svg: $(ALL_SVGS)

code:
	$(DIA2SOL) "$(CONTRACTS_DIAGRAM)" "$(CONTRACTS_SOL_DIR)"

clean:
	rm -f *.eps *.svg *.pdf
	rm -rf "$(CONTRACTS_SOL_DIR)"

.dia.eps:
	$(DIA) -e "$@" -t eps-pango "$?"

.dia.pdf:
	$(DIA) -e "$@" -t pdf "$?"

.dia.svg:
	$(DIA) -e "$@" -t cairo-svg "$?"
