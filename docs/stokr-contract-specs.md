Specifications of the STOKR smart contracts
===========================================

Abstract
--------

Stokr is as crowd-investing plattform based on smart contracts on the Ethereum blickchain.
On STOKR many project will be depoloyed with the same smart contract structure.
There will be a shared wgitelist for all projects on STOKR.
Each project has its own ERC20 Token and its Crowdsale contract.
The token contract is able to distribute profits generated by the projects to the token holders.
There is a trusted Keyrecovery function to reimburse token holders that lost their private key.
Only addresses that are in the central STOKR whitelist can hold and send token.


Whitelist
---------
The whitelist contract has a mapping that stores a boolean value for every address.
This boolean stores wether this address is whitelisted or not. There is a public view function that takes an address and returns the boolean.
The whitelist contract has an owner address thats set on deployment and can be changed by the owner.
It also has a list of  administrator that can be set by the owner.
The owner can add and remove administrators.
Whitelist administrators can add investors to the whitelist.
Whitelist administrators can remove investors to the whitelist.
It's possible for a administrator to add and remove multible investors in one transaction.

Crowdsale
---------



The crowdsale contract generates new token by calling the mint function of the token contract.
The crowdsale contract has an owner address thats set on deployment and can be changed by the owner.
There are two sales, the public sale and the private sale. There are separate caps for each sale. The caps are calculated in amounts of tokens.

### Public sale

In the public sale investments are done in Ether via the payable fallback function or the payable buyTokens function or by a distribution function called by the owner using the distributeTokensViaPublicSale function.
The buyToken function has a minimumInvestmentAmount calculated in Tokens given in the constructor.


### Private sale

In the private sale tokens are only distributed by the owner using the distributeTokensViaPrivateSale function.

### etherRate / tokenPrice

There is a tokenPrice set in the constructor thats not changed. The tokenPrice is the price of one Token denominated in € cent.
There is a ethRate, the etherRate is representing the current price of Ether in € cent. This rate can be changed via the setRate function that can only be called by the rateAdmin that is set in the constructor.

### Timing

The crowdsale has and openingTime and a closingTime, limiting the time frame of public sale token purchases with Ether.


### Softcap / goal

The crowdsale required a minimum amount of token that need to be sold. This goal is set in the contsructor. If the goal is not reached the all investors that purchased with Ether will be refunded. The refund can be triggered by the investor calling the  claimRefund function or by the owner calling the distributeRefunds function.
Until the goal is reached the Ether invested will be stored in the Crowdsale contract. As soon a the goal is reached the total balance of the crowdsale contract will be forwarded to the companyWallet. After the goal is reached every incomming investment in Ether will be immidiatly forwarded to the companyWallet.

### finalization

The crowdsale contract has a finalize function that can be called by the owner after the sale has ended.
Upon finalization the tokenReserve will be minted to the reserveAccount which is set in the constructor.
The vaiable tokenReservePerMill is set in the constructor and specifies the The amount in the token reserve  as a fraction of the sold token in the private and the public sale.
The finalize function will call the finishMinting function of the token contract.
The finalize function set the boolean variable isFinalized to true.
The finalize function can only be called once.
If the goal of the crowdsale is not reached the destruct function of the token will be called.

Token contract
--------------

The token contract is an ERC20 token. The Token is mintable and has a role "minter" that can call the mint function. The token contract has an owner address thats set on deployment and can be changed by the owner. The minter role will be set by the the owner using the setMinter function to be the crowdsale contract.  During minting the token cortact counts the number of addresses that got tokens via the mint
function.

### Whitelisted
The token contract will store a whitelist address that is set in the constructor. The whitelist address can be changed by the token owner.
The ERC20 functions  transfer and transferFrom are restricted to whitelisted addresses. Only whitelisted addresses are allowed to receive and send tokens.  Minting tokens is also restricted to whitelisted addresses.

### ProfitSharing

The token contract has a payable depositProfit function and the payable fallback function where the profitDepositor set in the constructor can send Ether to the token contract. This function increases the total amount of profits to bew distributed amoung token holders. An function updateProfitShare will calculate the share a token holder holds of the total supply of tokens and calculate the profit share of the token holder accordingly.
the updateProfitShare function will be called in everytime the token balance is changing especially before any transfers are done. This ensures that each token holder get the profit share according to his percentace of the token suppy at any time. The function updateProfitShare is only allowed after the finalization of the crowdsale to ensure the total suppy is not changing.

The profit share, which is calculated by function profitShareOwing, of a token holder can be distributed by three different methods. A token holder can withdraw the profitShare to the address holding the token using the withdrawProfitShare function . A token holder can withdraw the profitShare to the any other address using the withdrawProfitShareTo function. The ProfitDistributor, a address set by the owner with the setProfitDistributor function, can trigger the withdrawl for any investor.

### KeyRecovery

The token contract has a keyRecoverer role set in the constructor that can call the recoverKey function. This function will copy the account state from an oldAddress to a newAddress and delete the balance a the profitShare of the old address. This requires that the newAddress has no balance and was never used in this token.  

### destruct

The token has a destruct function that will be called by the crowdsale contract in case the goal was not reached.

ProjectManager
--------------

The ProjectManager is a smart contract factory that has a createNewProject function, that will generate the token and crowdsale contract for a new project and stores the project in a project array. The token and the crowdsale contract each have a separate contract factory that can be set and changed by the owner of the ProjectManager. The ProjectManager stores the current whitelist contract address that can be set and changed by the owner of the ProjectManager.

The ProjectManager has a role rateAdmin that can be set and changed by the owner of the ProjectManager. The rateAdmin can call the setRate function. The setRate function 
